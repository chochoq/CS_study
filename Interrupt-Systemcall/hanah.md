출처) 

운영체제와 정보 기술의 원리, 반효경 저

[https://velog.io/@min1378/시스템구조와-프로그램-실행-1](https://velog.io/@min1378/%EC%8B%9C%EC%8A%A4%ED%85%9C%EA%B5%AC%EC%A1%B0%EC%99%80-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8-%EC%8B%A4%ED%96%89-1) (이미지 출처)

# 인터럽트
<img src = "https://user-images.githubusercontent.com/62924471/136400365-ac142a8a-9f50-40a5-abd3-bd027f5b282d.png" width="80%">

CPU는 메모리 내 명령(instruction) 하나를 수행할 때마다, 인터럽트 라인을 통해 인터럽트 발생을 확인하며, 인터럽트 라인에 신호가 들어오면 하던 일을 멈추고 인터럽트와 관련된 일을 수행한다.

그리고 이전에 진행하던 프로그램의 복귀 정보를 PCB(커널의 데이터 영역에 존재)에 저장한다.

인터럽트의 종류는 다양하기 때문에 각각의 인터럽트 발생 원인마다 라인을 다르게 해서 구분하게 된다.

### 하드웨어 인터럽트

컴퓨터 내 외부 장치(I/O device)를 관리하는 컨트롤러들이 CPU를 이용하는 서비스가 필요할 때 이를 통보하는 방식을 말한다.

통상적으로 인터럽트라고 하면 하드웨어 인터럽트를 의미한다.

### 소프트웨어 인터럽트

소프트웨어가 CPU의 인터럽트 라인을 셋팅하는 경우의 인터럽트를 말한다. 주로 **트랩(Trap)**이라는 용어로 불린다.

예외 상황(exception)과 시스템 콜(system call)을 예로 들 수 있다. 
이 두 가지의 경우 모두 사용자 프로세스로부터 CPU의 제어권을 운영체제에 넘겨 처리하게 된다. 이 때, 프로그램 코드가 인터럽트 라인을 세팅하는 명령을 실행해 **인터럽트를 발생**시킨 후 **제어권**이 넘어가게 되기 때문에, 이와 같은 경우들도 넓은 의미에서 인터럽트의 범주에 포함시킨다.

- 예외 상황 : 사용자 프로그램이 0 으로 나누는 연산 등의 비정상적인 작업을 시도하거나, 자신의 메모리 영역 바깥에 접근하려는 시도 등 권한이 없는 작업을 시도할 때 이에 대한 처리를 위해 발생시키는 인터럽트를 말한다.
- **시스템 콜** : 사용자 프로그램이 운영체제 내부에 정의된 코드를 실행하고 싶을 때, 운영체제에 서비스를 요청하는 방법이라고 볼 수 있다. 인터럽트 라인 세팅을 통해 CPU 제어권을 운영체제로 넘겨 키보드 입력이나 화면 출력 등의 작업을 처리할 수 있게 한다.

# 인터럽트 처리 루틴 (interrput service routine)

인터럽트 핸들러(interrput handler) 라고도 한다.

운영체제의 커널에는 인터럽트가 들어왔을 때, 해야 할 일이 미리 다 프로그래밍 되어 그 코드가 보관돼 있다. 이를 인터럽트 처리 루틴이라고 한다.

> **인터럽트 벡터(interrupt vector)**
인터럽트 종류마다 번호를 정하고, 각 번호마다 처리해야 할 코드( 인터럽트 처리 루틴 )의 위치를 가진 자료 구조를 말한다.
> 

# 시스템 콜
![image](https://user-images.githubusercontent.com/62924471/136400442-c5299718-b9eb-44d6-8ae0-0c1bd983a37c.png)

일종의 소프트웨어적인 인터럽트로서, 사용자 프로그램이 시스템 콜을 할 경우 트랩이 발생해 CPU의 제어권이 운영체제로 넘어가게 된다.

디스크, 키보드, 모니터 등의 I/O deivce 로의 입출력 명령은 특권 명령에 해당하므로, 사용자 프로그램이 직접 수행할 수 없다. 이러한 입출력 명령을 수행하기 위해 사용자 프로그램은 운영체제에게 시스템 콜이라는 서비스 대행 요청을 하여, 입출력을 수행한다.

외부 장치에 요청된 입출력 수행이 완료되면, 외부 장치의 컨트롤러가 다시 CPU에 인터럽트를 발생시켜 완료되었음을 알려, 해당 프로그램이 다시 CPU를 할당받을 수 있도록 한다.

### CPU의 특권 명령 / 일반 명령

CPU 내 모드 비트(mode bit)를 두고, 이를 이용해 명령의 실행 가능성을 체크하도록 한다.

- 특권 명령 : 보안이 필요한 명령으로 입출력 장치, 타이머 등 각종 장치에 접근하는 명령이다. 컴퓨터 시스템에서 이러한 특권 명령은 항상 운영체제만 수행할 수 있도록 제한하고 있다.
- 일반 명령 : 메모리에서 자료를 읽어 와 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령들을 말한다. 모든 프로그램이 수행할 수 있다.

### 커널 함수 (커널 주소 공간에 포함)

- 시스템 콜 함수 : 사용자 프로그램이 운영체제의 서비스를 요청하기 위해 호출하는 시스템 콜 함수
- 인터럽트 처리 함수 : 각종 하드웨어 및 소프트웨어가 CPU의 서비스를 요청하기 위해 발생시키는 인터럽트 처리 함수

### Context Switching이 발생하는 인터럽트 경우

사용자 프로그램이 할당된 CPU를 빼앗기는 경우

- 타이머에 의한 인터럽트 발생
    - 시분할 시스템 구현을 위해 필수적
- 입출력 요청을 위해 시스템 콜을 하는 경우
    1. 이 경우, CPU는 운영체제에게 이양되어 서비스 루틴으로 이동해 입출력 작업을 수행한다. 즉, I/O 디바이스의 컨트롤러에게 관련된 명령을 수행하도록 지시한다. 
    2. 이후 CPU의 제어권을 다른 프로세스에게 전달한다. 기존의 프로세스는 대부분의 경우 입출력을 요청한 다음, 요청한 결과 없이 다음 명령을 수행하기 어렵기 때문이다. 
    3. 그리고  CPU가 다른 프로세스의 명령어를 수행하는 중간에 입출력 요청을 받았던 I/O 디바이스가 작업을 완료하면, 인터럽트 라인을 세팅해 하드웨어 인터럽트가 발생한다. 
    4. CPU 제어권은 운영체제의 인터럽트 처리 루틴으로 넘어가고, I/O 디바이스의 로컬 버퍼에 저장된 결과를 메모리로 복사한 뒤, 입출력을 요청했던 프로세스에게 다시 CPU를 획득할 수 있는 권한을 준다. 
    5. 해당 프로세스는 CPU를 기다리는 Ready 큐에 삽입되고, 제어권은 직전에 인터럽트를 당한 프로세스에게 다시 돌아간다.
